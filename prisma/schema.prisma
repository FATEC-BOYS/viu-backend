generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// üë§ Usu√°rios
model Usuario {
  id       String  @id @default(dbgenerated("'c' || encode(gen_random_bytes(12), 'hex')"))
  email    String  @unique
  senha    String? // Opcional para login social (Google, etc)
  nome     String
  telefone String?
  avatar   String?
  tipo     String  @default("DESIGNER") // TipoUsuario: DESIGNER, CLIENTE, ADMIN
  ativo    Boolean @default(true)

  // 2FA (Two-Factor Authentication)
  twoFactorEnabled     Boolean  @default(false)
  twoFactorSecret      String? // Secret do TOTP (criptografado)
  twoFactorBackupCodes String[] @default([]) // C√≥digos de backup

  // Timestamps
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  // Relacionamentos
  projetosDesigner Projeto[]       @relation("ProjetoDesigner")
  projetosCliente  Projeto[]       @relation("ProjetoCliente")
  artes            Arte[]          @relation("ArteAutor")
  feedbacks        Feedback[]      @relation("FeedbackAutor")
  aprovacoes       Aprovacao[]     @relation("AprovacaoAprovador")
  tarefas          Tarefa[]        @relation("TarefaResponsavel")
  notificacoes     Notificacao[]   @relation("NotificacaoUsuario")
  sessoes          Sessao[]        @relation("SessaoUsuario")
  auditLogs        AuditLog[]      @relation("AuditLogUsuario")
  securityEvents   SecurityEvent[] @relation("SecurityEventUsuario")

  @@index([email])
  @@index([tipo])
  @@index([ativo])
  @@index([criadoEm])
  @@map("usuarios")
}

// üìÅ Projetos
model Projeto {
  id        String    @id @default(dbgenerated("'c' || encode(gen_random_bytes(12), 'hex')"))
  nome      String
  descricao String?
  status    String    @default("EM_ANDAMENTO") // StatusProjeto: EM_ANDAMENTO, CONCLUIDO, CANCELADO
  orcamento Int? // Em centavos
  prazo     DateTime?

  // Relacionamentos
  designerId String
  designer   Usuario @relation("ProjetoDesigner", fields: [designerId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  clienteId  String
  cliente    Usuario @relation("ProjetoCliente", fields: [clienteId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  artes   Arte[]   @relation("ArtesProjeto")
  tarefas Tarefa[] @relation("TarefasProjeto")

  // Timestamps
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@index([designerId])
  @@index([clienteId])
  @@index([status])
  @@index([criadoEm])
  @@map("projetos")
}

// üé® Artes/Arquivos
model Arte {
  id        String  @id @default(dbgenerated("'c' || encode(gen_random_bytes(12), 'hex')"))
  nome      String
  descricao String?
  arquivo   String // URL/path do arquivo
  tipo      String // TipoArte: IMAGEM, VIDEO, PDF, etc
  tamanho   Int // Em bytes
  versao    Int     @default(1)
  status    String  @default("EM_ANALISE") // StatusArte: EM_ANALISE, APROVADO, REJEITADO

  // Relacionamentos
  projetoId String
  projeto   Projeto @relation("ArtesProjeto", fields: [projetoId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  autorId   String
  autor     Usuario @relation("ArteAutor", fields: [autorId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  feedbacks           Feedback[]          @relation("FeedbacksArte")
  aprovacoes          Aprovacao[]         @relation("AprovacoesArte")
  linksCompartilhados LinkCompartilhado[] @relation("LinksArte")

  // Timestamps
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@index([projetoId])
  @@index([autorId])
  @@index([status])
  @@index([tipo])
  @@index([criadoEm])
  @@map("artes")
}

// üí¨ Feedbacks
model Feedback {
  id       String  @id @default(dbgenerated("'c' || encode(gen_random_bytes(12), 'hex')"))
  conteudo String
  tipo     String  @default("TEXTO") // TipoFeedback: TEXTO, AUDIO, POSICIONAL
  arquivo  String? // Para feedback de √°udio
  posicaoX Float? // Para feedback posicional
  posicaoY Float?

  // Campos de transcri√ß√£o / TTS
  transcricao String? // Texto transcrito a partir do √°udio (STT)
  audioGerado String? // URL do √°udio gerado a partir do texto (TTS)

  // Relacionamentos
  arteId  String
  arte    Arte    @relation("FeedbacksArte", fields: [arteId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  autorId String
  autor   Usuario @relation("FeedbackAutor", fields: [autorId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  // Timestamps
  criadoEm DateTime @default(now())

  @@index([arteId])
  @@index([autorId])
  @@index([tipo])
  @@index([criadoEm])
  @@map("feedbacks")
}

// ‚úÖ Aprova√ß√µes
model Aprovacao {
  id         String  @id @default(dbgenerated("'c' || encode(gen_random_bytes(12), 'hex')"))
  status     String  @default("PENDENTE") // StatusAprovacao: PENDENTE, APROVADO, REJEITADO
  comentario String?

  // Relacionamentos
  arteId      String
  arte        Arte    @relation("AprovacoesArte", fields: [arteId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  aprovadorId String
  aprovador   Usuario @relation("AprovacaoAprovador", fields: [aprovadorId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  // Timestamps
  criadoEm DateTime @default(now())

  @@index([arteId])
  @@index([aprovadorId])
  @@index([status])
  @@index([criadoEm])
  @@map("aprovacoes")
}

// üìã Tarefas
model Tarefa {
  id         String    @id @default(dbgenerated("'c' || encode(gen_random_bytes(12), 'hex')"))
  titulo     String
  descricao  String?
  status     String    @default("PENDENTE") // StatusTarefa: PENDENTE, EM_ANDAMENTO, CONCLUIDA
  prioridade String    @default("MEDIA") // Prioridade: BAIXA, MEDIA, ALTA
  prazo      DateTime?

  // Relacionamentos
  projetoId     String?
  projeto       Projeto? @relation("TarefasProjeto", fields: [projetoId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  responsavelId String
  responsavel   Usuario  @relation("TarefaResponsavel", fields: [responsavelId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  // Timestamps
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@index([projetoId])
  @@index([responsavelId])
  @@index([status])
  @@index([prioridade])
  @@index([prazo])
  @@map("tarefas")
}

// üîî Notifica√ß√µes
model Notificacao {
  id       String  @id @default(dbgenerated("'c' || encode(gen_random_bytes(12), 'hex')"))
  titulo   String
  conteudo String
  tipo     String // TipoNotificacao: SISTEMA, FEEDBACK, APROVACAO, TAREFA
  canal    String  @default("SISTEMA") // CanalNotificacao: SISTEMA, EMAIL, PUSH
  lida     Boolean @default(false)

  // Relacionamentos
  usuarioId String
  usuario   Usuario @relation("NotificacaoUsuario", fields: [usuarioId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // Timestamps
  criadoEm DateTime @default(now())

  @@index([usuarioId])
  @@index([tipo])
  @@index([lida])
  @@index([criadoEm])
  @@map("notificacoes")
}

// üîê Sess√µes (para JWT/Auth)
model Sessao {
  id        String   @id @default(dbgenerated("'c' || encode(gen_random_bytes(12), 'hex')"))
  token     String   @unique
  expiresAt DateTime
  ativo     Boolean  @default(true)

  // Relacionamentos
  usuarioId String
  usuario   Usuario @relation("SessaoUsuario", fields: [usuarioId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // Timestamps
  criadoEm DateTime @default(now())

  @@index([usuarioId])
  @@index([token])
  @@index([expiresAt])
  @@index([ativo])
  @@map("sessoes")
}

// üìù Audit Logs (Registro de Auditoria)
model AuditLog {
  id String @id @default(dbgenerated("'c' || encode(gen_random_bytes(12), 'hex')"))

  // A√ß√£o realizada
  action     String  @db.Text // Ex: "LOGIN", "CREATE_PROJECT", "UPDATE_USER", "DELETE_ARTE"
  resource   String  @db.Text // Ex: "Usuario", "Projeto", "Arte"
  resourceId String? @db.Text // ID do recurso afetado

  // Detalhes da a√ß√£o
  details   Json?   @db.JsonB // Dados adicionais sobre a a√ß√£o (before/after, params, etc)
  ipAddress String? @db.Text // IP de origem
  userAgent String? @db.Text // User agent do navegador

  // Status e resultado
  status       String  @db.Text // "SUCCESS" ou "FAILURE"
  errorMessage String? @db.Text // Mensagem de erro se falhou

  // Relacionamento com usu√°rio (quem executou a a√ß√£o)
  usuarioId String?
  usuario   Usuario? @relation("AuditLogUsuario", fields: [usuarioId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  // Timestamp
  criadoEm DateTime @default(now())

  @@index([usuarioId])
  @@index([action])
  @@index([resource])
  @@index([status])
  @@index([criadoEm])
  @@map("audit_logs")
}

// üîí Security Events (Eventos de Seguran√ßa)
model SecurityEvent {
  id String @id @default(dbgenerated("'c' || encode(gen_random_bytes(12), 'hex')"))

  // Tipo de evento de seguran√ßa
  eventType String @db.Text // "FAILED_LOGIN", "ACCOUNT_LOCKOUT", "SUSPICIOUS_ACTIVITY", "PASSWORD_CHANGE"
  severity  String @db.Text // "LOW", "MEDIUM", "HIGH", "CRITICAL"

  // Detalhes do evento
  description String @db.Text
  details     Json?  @db.JsonB // Informa√ß√µes adicionais

  // Origem do evento
  ipAddress String? @db.Text
  userAgent String? @db.Text
  location  String? @db.Text // Geolocaliza√ß√£o (cidade, pa√≠s)

  // Relacionamento com usu√°rio (se aplic√°vel)
  usuarioId String?
  usuario   Usuario? @relation("SecurityEventUsuario", fields: [usuarioId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  // Status de resposta
  resolved   Boolean   @default(false)
  resolvedAt DateTime?
  resolvedBy String?   @db.Text // ID do admin que resolveu

  // Timestamp
  criadoEm DateTime @default(now())

  @@index([usuarioId])
  @@index([eventType])
  @@index([severity])
  @@index([resolved])
  @@index([criadoEm])
  @@map("security_events")
}

// üîó Links Compartilhados (Shared Links)
model LinkCompartilhado {
  id String @id @default(dbgenerated("'c' || encode(gen_random_bytes(12), 'hex')"))

  // Token √∫nico para acesso
  token String @unique

  // Tipo de recurso compartilhado
  tipo String @db.Text // "ARTE", "PROJETO", etc.

  // Relacionamento com Arte (se tipo = "ARTE")
  arteId String?
  arte   Arte?   @relation("LinksArte", fields: [arteId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // Configura√ß√µes de acesso
  somenteLeitura Boolean   @default(true)
  expiraEm       DateTime? // Null = nunca expira

  // Timestamps
  criadoEm DateTime @default(now())

  @@index([token])
  @@index([arteId])
  @@index([expiraEm])
  @@map("link_compartilhado")
}
