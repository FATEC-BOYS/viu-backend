generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// üë§ Usu√°rios
model Usuario {
  id       String  @id @default(cuid())
  email    String  @unique
  senha    String
  nome     String
  telefone String?
  avatar   String?
  tipo     String  @default("DESIGNER") // TipoUsuario
  ativo    Boolean @default(true)

  // 2FA (Two-Factor Authentication)
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String? // Secret do TOTP (criptografado)
  twoFactorBackupCodes String[] @default([]) // C√≥digos de backup

  // Timestamps
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  // Relacionamentos
  projetosDesigner Projeto[]     @relation("ProjetoDesigner")
  projetosCliente  Projeto[]     @relation("ProjetoCliente")
  artes            Arte[]
  feedbacks        Feedback[]
  aprovacoes       Aprovacao[]
  tarefas          Tarefa[]
  notificacoes     Notificacao[]
  sessoes          Sessao[]
  auditLogs        AuditLog[]
  securityEvents   SecurityEvent[]

  @@index([email])
  @@index([tipo])
  @@index([ativo])
  @@index([criadoEm])
  // √çndices para performance
  @@map("usuarios")
}

// üìÅ Projetos
model Projeto {
  id        String    @id @default(cuid())
  nome      String
  descricao String?
  status    String    @default("EM_ANDAMENTO") // StatusProjeto
  orcamento Int? // Em centavos
  prazo     DateTime?

  // Relacionamentos
  designerId String
  designer   Usuario @relation("ProjetoDesigner", fields: [designerId], references: [id])
  clienteId  String
  cliente    Usuario @relation("ProjetoCliente", fields: [clienteId], references: [id])

  artes   Arte[]
  tarefas Tarefa[]

  // Timestamps
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@index([designerId])
  @@index([clienteId])
  @@index([status])
  @@index([criadoEm])
  @@map("projetos")
}

// üé® Artes/Arquivos
model Arte {
  id        String  @id @default(cuid())
  nome      String
  descricao String?
  arquivo   String // URL/path do arquivo
  tipo      String // TipoArte
  tamanho   Int // Em bytes
  versao    Int     @default(1)
  status    String  @default("EM_ANALISE") // StatusArte

  // Relacionamentos
  projetoId String
  projeto   Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  autorId   String
  autor     Usuario @relation(fields: [autorId], references: [id])

  feedbacks  Feedback[]
  aprovacoes Aprovacao[]
  linksCompartilhados LinkCompartilhado[]

  // Timestamps
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@index([projetoId])
  @@index([autorId])
  @@index([status])
  @@index([tipo])
  @@index([criadoEm])
  @@map("artes")
}

// üí¨ Feedbacks
model Feedback {
  id       String  @id @default(cuid())
  conteudo String
  tipo     String  @default("TEXTO") // TipoFeedback
  arquivo  String? // Para feedback de √°udio
  posicaoX Float? // Para feedback posicional
  posicaoY Float?

  // Campos de transcri√ß√£o / TTS
  transcricao String? // Texto transcrito a partir do √°udio (STT)
  audioGerado String? // URL do √°udio gerado a partir do texto (TTS)

  // Relacionamentos
  arteId  String
  arte    Arte    @relation(fields: [arteId], references: [id], onDelete: Cascade)
  autorId String
  autor   Usuario @relation(fields: [autorId], references: [id])

  // Timestamps
  criadoEm DateTime @default(now())

  @@index([arteId])
  @@index([autorId])
  @@index([tipo])
  @@index([criadoEm])
  @@map("feedbacks")
}

// ‚úÖ Aprova√ß√µes
model Aprovacao {
  id         String  @id @default(cuid())
  status     String  @default("PENDENTE") // StatusAprovacao
  comentario String?

  // Relacionamentos
  arteId      String
  arte        Arte    @relation(fields: [arteId], references: [id], onDelete: Cascade)
  aprovadorId String
  aprovador   Usuario @relation(fields: [aprovadorId], references: [id])

  // Timestamps
  criadoEm DateTime @default(now())

  @@index([arteId])
  @@index([aprovadorId])
  @@index([status])
  @@index([criadoEm])
  @@map("aprovacoes")
}

// üìã Tarefas
model Tarefa {
  id         String    @id @default(cuid())
  titulo     String
  descricao  String?
  status     String    @default("PENDENTE") // StatusTarefa
  prioridade String    @default("MEDIA") // Prioridade
  prazo      DateTime?

  // Relacionamentos
  projetoId     String?
  projeto       Projeto? @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  responsavelId String
  responsavel   Usuario  @relation(fields: [responsavelId], references: [id])

  // Timestamps
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@index([projetoId])
  @@index([responsavelId])
  @@index([status])
  @@index([prioridade])
  @@index([prazo])
  @@map("tarefas")
}

// üîî Notifica√ß√µes
model Notificacao {
  id       String  @id @default(cuid())
  titulo   String
  conteudo String
  tipo     String // TipoNotificacao
  canal    String  @default("SISTEMA") // CanalNotificacao
  lida     Boolean @default(false)

  // Relacionamentos
  usuarioId String
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  // Timestamps
  criadoEm DateTime @default(now())

  @@index([usuarioId])
  @@index([tipo])
  @@index([lida])
  @@index([criadoEm])
  @@map("notificacoes")
}

// üîê Sess√µes (para JWT/Auth)
model Sessao {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  ativo     Boolean  @default(true)

  // Relacionamentos
  usuarioId String
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  // Timestamps
  criadoEm DateTime @default(now())

  @@index([usuarioId])
  @@index([token])
  @@index([expiresAt])
  @@index([ativo])
  @@map("sessoes")
}

// üìù Audit Logs (Registro de Auditoria)
model AuditLog {
  id String @id @default(cuid())

  // A√ß√£o realizada
  action String // Ex: "LOGIN", "CREATE_PROJECT", "UPDATE_USER", "DELETE_ARTE"
  resource String // Ex: "Usuario", "Projeto", "Arte"
  resourceId String? // ID do recurso afetado

  // Detalhes da a√ß√£o
  details Json? // Dados adicionais sobre a a√ß√£o (before/after, params, etc)
  ipAddress String? // IP de origem
  userAgent String? // User agent do navegador

  // Status e resultado
  status String // "SUCCESS" ou "FAILURE"
  errorMessage String? // Mensagem de erro se falhou

  // Relacionamento com usu√°rio (quem executou a a√ß√£o)
  usuarioId String?
  usuario Usuario? @relation(fields: [usuarioId], references: [id], onDelete: SetNull)

  // Timestamp
  criadoEm DateTime @default(now())

  @@index([usuarioId])
  @@index([action])
  @@index([resource])
  @@index([status])
  @@index([criadoEm])
  @@map("audit_logs")
}

// üîí Security Events (Eventos de Seguran√ßa)
model SecurityEvent {
  id String @id @default(cuid())

  // Tipo de evento de seguran√ßa
  eventType String // "FAILED_LOGIN", "ACCOUNT_LOCKOUT", "SUSPICIOUS_ACTIVITY", "PASSWORD_CHANGE"
  severity String // "LOW", "MEDIUM", "HIGH", "CRITICAL"

  // Detalhes do evento
  description String
  details Json? // Informa√ß√µes adicionais

  // Origem do evento
  ipAddress String?
  userAgent String?
  location String? // Geolocaliza√ß√£o (cidade, pa√≠s)

  // Relacionamento com usu√°rio (se aplic√°vel)
  usuarioId String?
  usuario Usuario? @relation(fields: [usuarioId], references: [id], onDelete: SetNull)

  // Status de resposta
  resolved Boolean @default(false)
  resolvedAt DateTime?
  resolvedBy String? // ID do admin que resolveu

  // Timestamp
  criadoEm DateTime @default(now())

  @@index([usuarioId])
  @@index([eventType])
  @@index([severity])
  @@index([resolved])
  @@index([criadoEm])
  @@map("security_events")
}

// üîó Links Compartilhados (Shared Links)
model LinkCompartilhado {
  id String @id @default(cuid())

  // Token √∫nico para acesso
  token String @unique

  // Tipo de recurso compartilhado
  tipo String // "ARTE", "PROJETO", etc.

  // Relacionamento com Arte (se tipo = "ARTE")
  arteId String?
  arte Arte? @relation(fields: [arteId], references: [id], onDelete: Cascade)

  // Configura√ß√µes de acesso
  somenteLeitura Boolean @default(true)
  expiraEm DateTime? // Null = nunca expira

  // Timestamps
  criadoEm DateTime @default(now())

  @@index([token])
  @@index([arteId])
  @@index([expiraEm])
  @@map("link_compartilhado")
}
